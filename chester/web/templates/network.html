{% extends "base.html" %}

{% block title %}Bot Network - {{ config.name }}{% endblock %}

{% block extra_css %}
<style>
    #network {
        width: 100%;
        height: 700px;
        min-height: 700px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
    }

    .network-header {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .network-header h2 {
        color: #2a5298;
        margin: 0;
    }

    .network-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .network-controls button {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        background: #2a5298;
        color: white;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.3s;
    }

    .network-controls button:hover {
        background: #1e3c72;
    }

    .info-panel {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .info-panel h3 {
        color: #2a5298;
        margin-top: 0;
        margin-bottom: 10px;
    }

    .info-panel p {
        margin: 5px 0;
        color: #495057;
    }

    .info-panel .emoji {
        font-size: 2em;
        margin-right: 10px;
    }

    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .stat-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        text-align: center;
    }

    .stat-card .number {
        font-size: 2em;
        font-weight: bold;
        color: #2a5298;
    }

    .stat-card .label {
        color: #6c757d;
        font-size: 0.9em;
        margin-top: 5px;
    }

    .legend {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #ccc;
    }

    #loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        font-size: 1.1em;
    }
</style>
{% endblock %}

{% block content %}
<div class="network-header">
    <h2>üï∏Ô∏è Bot Network Visualization</h2>
    <div class="network-controls">
        <button onclick="fitNetwork()">üìê Fit All</button>
        <button onclick="resetPhysics()">üîÑ Reset Layout</button>
        <button onclick="togglePhysics()">‚ö° Toggle Physics</button>
    </div>
</div>

<div class="stats">
    <div class="stat-card">
        <div class="number" id="total-bots">-</div>
        <div class="label">Total Bots</div>
    </div>
    <div class="stat-card">
        <div class="number" id="total-connections">-</div>
        <div class="label">Dependencies</div>
    </div>
    <div class="stat-card">
        <div class="number" id="most-connected">-</div>
        <div class="label">Most Connected</div>
    </div>
</div>

<div class="legend">
    <div class="legend-item">
        <div class="legend-color" style="background: #97C2FC;"></div>
        <span>Has Dependencies</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #FB7E81;"></div>
        <span>Core Service (No Dependencies)</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background: #7BE141;"></div>
        <span>Selected Bot</span>
    </div>
</div>

<div id="loading">Loading bot network...</div>
<div id="network" style="display: none;"></div>

<div id="info-panel" class="info-panel" style="display: none;">
    <h3><span class="emoji" id="bot-emoji">ü§ñ</span><span id="bot-name"></span></h3>
    <p><strong>Description:</strong> <span id="bot-description"></span></p>
    <p><strong>Version:</strong> <span id="bot-version"></span></p>
    <p id="bot-personality-container" style="display: none;"><strong>Personality:</strong> <span id="bot-personality"></span></p>
    <p><strong>Dependencies:</strong> <span id="bot-dependencies"></span></p>
    <p><strong>Depended on by:</strong> <span id="bot-dependents"></span></p>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
let network = null;
let networkData = null;
let physicsEnabled = true;

// Fetch network data from API
async function loadNetworkData() {
    try {
        const response = await fetch('/network/data');
        const data = await response.json();

        if (data.success) {
            networkData = data;
            createNetwork(data.nodes, data.edges);
            updateStats(data.nodes, data.edges);
        } else {
            document.getElementById('loading').textContent = 'Error loading network data';
        }
    } catch (error) {
        console.error('Error loading network:', error);
        document.getElementById('loading').textContent = 'Error loading network data';
    }
}

function updateStats(nodes, edges) {
    document.getElementById('total-bots').textContent = nodes.length;
    document.getElementById('total-connections').textContent = edges.length;

    // Find most connected bot
    const depCounts = {};
    edges.forEach(edge => {
        depCounts[edge.to] = (depCounts[edge.to] || 0) + 1;
    });

    let mostConnected = '-';
    let maxCount = 0;
    for (const [bot, count] of Object.entries(depCounts)) {
        if (count > maxCount) {
            maxCount = count;
            mostConnected = bot;
        }
    }

    if (mostConnected !== '-') {
        const node = nodes.find(n => n.id === mostConnected);
        mostConnected = `${node.emoji} ${node.label} (${maxCount})`;
    }

    document.getElementById('most-connected').textContent = mostConnected;
}

function createNetwork(nodes, edges) {
    // Create dependency counts
    const dependencyCounts = {};
    const dependents = {};

    edges.forEach(edge => {
        dependencyCounts[edge.from] = (dependencyCounts[edge.from] || 0) + 1;
        if (!dependents[edge.to]) dependents[edge.to] = [];
        dependents[edge.to].push(edge.from);
    });

    // Transform nodes for vis.js
    const visNodes = nodes.map(node => {
        const hasDeps = dependencyCounts[node.id] > 0;
        const isDepended = dependents[node.id] && dependents[node.id].length > 0;

        return {
            id: node.id,
            label: `${node.emoji}\n${node.label}`,
            title: `<b>${node.emoji} ${node.label}</b><br>${node.description}<br><i>Click for details</i>`,
            shape: 'box',
            color: {
                background: hasDeps ? '#97C2FC' : '#FB7E81',
                border: '#2B7CE9',
                highlight: {
                    background: '#7BE141',
                    border: '#41A317'
                }
            },
            font: {
                size: 14,
                face: 'Arial'
            },
            margin: 10,
            data: node
        };
    });

    // Transform edges for vis.js
    const visEdges = edges.map(edge => ({
        from: edge.from,
        to: edge.to,
        arrows: 'to',
        color: {
            color: '#848484',
            highlight: '#2a5298'
        },
        smooth: {
            type: 'cubicBezier',
            forceDirection: 'horizontal'
        }
    }));

    // Create network
    const container = document.getElementById('network');
    const data = {
        nodes: new vis.DataSet(visNodes),
        edges: new vis.DataSet(visEdges)
    };

    const options = {
        layout: {
            hierarchical: {
                enabled: false
            }
        },
        physics: {
            enabled: true,
            barnesHut: {
                gravitationalConstant: -2000,
                centralGravity: 0.3,
                springLength: 150,
                springConstant: 0.04,
                damping: 0.09,
                avoidOverlap: 0.5
            },
            stabilization: {
                iterations: 200
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 100,
            navigationButtons: true,
            keyboard: true
        }
    };

    network = new vis.Network(container, data, options);

    // Show network when stabilized
    network.once('stabilizationIterationsDone', function() {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('network').style.display = 'block';
        network.fit();
    });

    // Handle node clicks
    network.on('click', function(params) {
        if (params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            const node = nodes.find(n => n.id === nodeId);
            showBotInfo(node, edges, nodes, dependents);
        }
    });
}

function showBotInfo(node, edges, allNodes, dependents) {
    const infoPanel = document.getElementById('info-panel');

    document.getElementById('bot-emoji').textContent = node.emoji;
    document.getElementById('bot-name').textContent = node.label;
    document.getElementById('bot-description').textContent = node.description || 'No description';
    document.getElementById('bot-version').textContent = node.version || 'Unknown';

    if (node.personality) {
        document.getElementById('bot-personality').textContent = node.personality;
        document.getElementById('bot-personality-container').style.display = 'block';
    } else {
        document.getElementById('bot-personality-container').style.display = 'none';
    }

    // Find dependencies
    const deps = edges.filter(e => e.from === node.id).map(e => {
        const depNode = allNodes.find(n => n.id === e.to);
        return depNode ? `${depNode.emoji} ${depNode.label}` : e.to;
    });
    document.getElementById('bot-dependencies').textContent = deps.length > 0 ? deps.join(', ') : 'None';

    // Find dependents
    const nodeDependents = (dependents[node.id] || []).map(depId => {
        const depNode = allNodes.find(n => n.id === depId);
        return depNode ? `${depNode.emoji} ${depNode.label}` : depId;
    });
    document.getElementById('bot-dependents').textContent = nodeDependents.length > 0 ? nodeDependents.join(', ') : 'None';

    infoPanel.style.display = 'block';
}

function fitNetwork() {
    if (network) {
        network.fit({
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            }
        });
    }
}

function resetPhysics() {
    if (network) {
        network.setOptions({ physics: true });
        physicsEnabled = true;
        setTimeout(() => {
            network.stabilize();
        }, 100);
    }
}

function togglePhysics() {
    if (network) {
        physicsEnabled = !physicsEnabled;
        network.setOptions({ physics: physicsEnabled });
    }
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', loadNetworkData);
</script>
{% endblock %}
