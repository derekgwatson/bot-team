{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Operation #{{ operation.id }}</h2>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <div>
            <p><strong>Type:</strong>
                {% if operation.operation_type == 'create_user' %}
                    <span style="color: #27ae60;">Create User</span>
                {% elif operation.operation_type == 'archive_user' %}
                    <span style="color: #f39c12;">Archive User</span>
                {% elif operation.operation_type == 'delete_user' %}
                    <span style="color: #e74c3c;">Delete User</span>
                {% else %}
                    {{ operation.operation_type }}
                {% endif %}
            </p>
            <p><strong>Target:</strong> {{ operation.target_email or 'N/A' }}</p>
            {% if operation.target_name %}
            <p><strong>Name:</strong> {{ operation.target_name }}</p>
            {% endif %}
        </div>
        <div>
            <p><strong>Status:</strong>
                {% if operation.status == 'pending' %}
                    <span class="badge badge-info">Pending</span>
                {% elif operation.status == 'executing' %}
                    <span class="badge badge-warning">Executing</span>
                {% elif operation.status == 'completed' %}
                    <span class="badge badge-success">Completed</span>
                {% elif operation.status == 'failed' %}
                    <span class="badge badge-danger">Failed</span>
                {% elif operation.status == 'cancelled' %}
                    <span class="badge badge-secondary">Cancelled</span>
                {% endif %}
            </p>
            <p><strong>Created:</strong> {{ operation.created_date or 'N/A' }}</p>
            {% if operation.executed_date %}
            <p><strong>Executed:</strong> {{ operation.executed_date }}</p>
            {% endif %}
        </div>
    </div>

    {% if operation.error_message %}
    <div class="error" style="margin-bottom: 20px;">
        <strong>Error:</strong> {{ operation.error_message }}
    </div>
    {% endif %}

    {% if operation.status == 'completed' and operation.result_data %}
    <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border: 1px solid #a5d6a7; margin-bottom: 20px;">
        <h3 style="color: #2e7d32; margin-bottom: 15px;">Operation Result</h3>

        {% if operation.operation_type == 'create_user' and operation.result_data %}
        <div style="display: grid; gap: 15px;">
            {% if operation.result_data.email %}
            <div>
                <strong>Email:</strong>
                <code style="background: white; padding: 5px 10px; border-radius: 4px; margin-left: 10px;">{{ operation.result_data.email }}</code>
                <button type="button" onclick="copyToClipboard('{{ operation.result_data.email }}')"
                        style="margin-left: 8px; padding: 3px 10px; cursor: pointer; border: 1px solid #27ae60; background: white; border-radius: 4px; color: #27ae60; font-size: 12px;">Copy</button>
            </div>
            {% endif %}

            {% if operation.result_data.password %}
            <div>
                <strong>Password:</strong>
                <code style="background: white; padding: 5px 10px; border-radius: 4px; margin-left: 10px; font-size: 14px;">{{ operation.result_data.password }}</code>
                <button type="button" onclick="copyToClipboard('{{ operation.result_data.password }}')"
                        style="margin-left: 8px; padding: 3px 10px; cursor: pointer; border: 1px solid #27ae60; background: white; border-radius: 4px; color: #27ae60; font-size: 12px;">Copy</button>
            </div>
            {% endif %}

            {% if operation.result_data.backup_codes %}
            <div style="margin-top: 10px;">
                <strong>2FA Backup Codes:</strong>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px;">
                    {% for code in operation.result_data.backup_codes %}
                    <div style="background: white; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 14px; text-align: center; border: 1px solid #c8e6c9;">
                        {{ code }}
                    </div>
                    {% endfor %}
                </div>
                <button type="button" onclick="copyBackupCodes()"
                        style="margin-top: 10px; padding: 6px 15px; cursor: pointer; border: 1px solid #27ae60; background: #27ae60; border-radius: 4px; color: white; font-size: 12px;">
                    Copy All Backup Codes
                </button>
            </div>
            {% endif %}
        </div>
        {% elif operation.operation_type == 'archive_user' %}
        <p style="color: #2e7d32;">User {{ operation.target_email }} has been archived successfully.</p>
        {% elif operation.operation_type == 'delete_user' %}
        <p style="color: #2e7d32;">User {{ operation.target_email }} has been permanently deleted.</p>
        {% endif %}
    </div>
    {% endif %}

    <div style="margin-top: 20px;">
        <a href="{{ url_for('web.pending') }}" class="btn" style="background: #95a5a6;">Back to Pending</a>

        {% if operation.status == 'pending' %}
        <form method="POST" action="{{ url_for('web.execute_operation', operation_id=operation.id) }}" style="display: inline; margin-left: 10px;">
            <button type="submit" class="btn" style="background: #27ae60;">Execute Now</button>
        </form>
        <form method="POST" action="{{ url_for('web.cancel_operation', operation_id=operation.id) }}" style="display: inline; margin-left: 10px;">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Cancel this operation?')">Cancel</button>
        </form>
        {% elif operation.status == 'failed' %}
        <form method="POST" action="{{ url_for('web.retry_operation', operation_id=operation.id) }}" style="display: inline; margin-left: 10px;">
            <button type="submit" class="btn btn-warning">Retry</button>
        </form>
        {% endif %}
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Visual feedback could be added here
    });
}

function copyBackupCodes() {
    const codes = [
        {% for code in operation.result_data.backup_codes %}'{{ code }}'{% if not loop.last %}, {% endif %}{% endfor %}
    ];
    const text = codes.join('\n');
    navigator.clipboard.writeText(text).then(() => {
        alert('Backup codes copied to clipboard!');
    });
}
</script>
{% endblock %}
