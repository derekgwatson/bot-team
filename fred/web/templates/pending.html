{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Pending Operations</h2>
    <p style="color: #666; margin-bottom: 20px;">Operations queued for execution. Click "Execute" to run an operation or "Execute All" to run all pending operations.</p>

    {% if error %}
    <div class="error">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% if operations %}
    <div style="margin-bottom: 20px;">
        <form method="POST" action="{{ url_for('web.execute_all_pending') }}" style="display: inline;">
            <button type="submit" class="btn" style="background: #27ae60;"
                    onclick="return confirm('Execute all {{ operations|selectattr('status', 'equalto', 'pending')|list|length }} pending operations?')">
                Execute All Pending
            </button>
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Target</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for op in operations %}
            <tr>
                <td>#{{ op.id }}</td>
                <td>
                    {% if op.operation_type == 'create_user' %}
                        <span style="color: #27ae60;">Create User</span>
                    {% elif op.operation_type == 'archive_user' %}
                        <span style="color: #f39c12;">Archive User</span>
                    {% elif op.operation_type == 'delete_user' %}
                        <span style="color: #e74c3c;">Delete User</span>
                    {% else %}
                        {{ op.operation_type }}
                    {% endif %}
                </td>
                <td>
                    <strong>{{ op.target_email or 'N/A' }}</strong>
                    {% if op.target_name %}<br><small style="color: #666;">{{ op.target_name }}</small>{% endif %}
                </td>
                <td>
                    {% if op.status == 'pending' %}
                        <span class="badge badge-info">Pending</span>
                    {% elif op.status == 'executing' %}
                        <span class="badge badge-warning">Executing</span>
                    {% elif op.status == 'completed' %}
                        <span class="badge badge-success">Completed</span>
                    {% elif op.status == 'failed' %}
                        <span class="badge badge-danger">Failed</span>
                        {% if op.error_message %}
                        <br><small style="color: #e74c3c;">{{ op.error_message }}</small>
                        {% endif %}
                    {% elif op.status == 'cancelled' %}
                        <span class="badge badge-secondary">Cancelled</span>
                    {% else %}
                        <span class="badge">{{ op.status }}</span>
                    {% endif %}
                </td>
                <td>{{ op.created_date[:16] if op.created_date else 'N/A' }}</td>
                <td>
                    {% if op.status == 'pending' %}
                    <form method="POST" action="{{ url_for('web.execute_operation', operation_id=op.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-small" style="background: #27ae60;">Execute</button>
                    </form>
                    <form method="POST" action="{{ url_for('web.cancel_operation', operation_id=op.id) }}" style="display: inline; margin-left: 5px;">
                        <button type="submit" class="btn btn-small" style="background: #95a5a6;"
                                onclick="return confirm('Cancel this operation?')">Cancel</button>
                    </form>
                    {% elif op.status == 'failed' %}
                    <form method="POST" action="{{ url_for('web.retry_operation', operation_id=op.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-small btn-warning">Retry</button>
                    </form>
                    {% elif op.status == 'completed' %}
                    <a href="{{ url_for('web.operation_detail', operation_id=op.id) }}" class="btn btn-small">View Result</a>
                    {% else %}
                    <span style="color: #999;">-</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No pending operations</h3>
        <p>Operations will appear here when you use "Queue for Later" on user forms.</p>
    </div>
    {% endif %}
</div>

{% if completed_operations %}
<div class="card" style="margin-top: 20px;">
    <h2>Recently Completed</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Target</th>
                <th>Status</th>
                <th>Executed</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for op in completed_operations %}
            <tr>
                <td>#{{ op.id }}</td>
                <td>
                    {% if op.operation_type == 'create_user' %}
                        <span style="color: #27ae60;">Create User</span>
                    {% elif op.operation_type == 'archive_user' %}
                        <span style="color: #f39c12;">Archive User</span>
                    {% elif op.operation_type == 'delete_user' %}
                        <span style="color: #e74c3c;">Delete User</span>
                    {% else %}
                        {{ op.operation_type }}
                    {% endif %}
                </td>
                <td>
                    <strong>{{ op.target_email or 'N/A' }}</strong>
                    {% if op.target_name %}<br><small style="color: #666;">{{ op.target_name }}</small>{% endif %}
                </td>
                <td>
                    {% if op.status == 'completed' %}
                        <span class="badge badge-success">Completed</span>
                    {% elif op.status == 'failed' %}
                        <span class="badge badge-danger">Failed</span>
                    {% elif op.status == 'cancelled' %}
                        <span class="badge badge-secondary">Cancelled</span>
                    {% endif %}
                </td>
                <td>{{ op.executed_date[:16] if op.executed_date else 'N/A' }}</td>
                <td>
                    <a href="{{ url_for('web.operation_detail', operation_id=op.id) }}" class="btn btn-small">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% endblock %}
