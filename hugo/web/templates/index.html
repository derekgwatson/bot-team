{% extends "base.html" %}

{% block title %}Dashboard - {{ config.name }}{% endblock %}

{% block content %}
<h2>Dashboard</h2>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_users }}</div>
        <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
        <div class="stat-value text-success">{{ stats.active_users }}</div>
        <div class="stat-label">Active</div>
    </div>
    <div class="stat-card">
        <div class="stat-value text-danger">{{ stats.inactive_users }}</div>
        <div class="stat-label">Inactive</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ config.available_orgs|length }}</div>
        <div class="stat-label">Organizations</div>
    </div>
    <a href="{{ url_for('web.queue') }}" class="stat-card" style="text-decoration: none; color: inherit;{% if queue_stats.pending > 0 %} background: #fff3cd;{% endif %}">
        <div class="stat-value">{{ queue_stats.pending }}</div>
        <div class="stat-label">Queued Changes</div>
    </a>
</div>

{% if queue_stats.pending > 0 %}
<div class="card" style="background: #e8f4fd;">
    <h3>Pending Changes</h3>
    <p>{{ queue_stats.pending }} change(s) queued for processing. <a href="{{ url_for('web.queue') }}">View details</a></p>
    {% if queue_stats.pending_by_org %}
    <ul style="margin: 10px 0;">
        {% for org, count in queue_stats.pending_by_org.items() %}
        <li>{{ org }}: {{ count }} change(s)</li>
        {% endfor %}
    </ul>
    {% endif %}
    <button class="btn btn-primary" onclick="processQueue(this)">Process Queue Now</button>
    <span class="text-muted" style="margin-left: 10px;">Or wait for automatic processing (every 15 mins)</span>
</div>
{% endif %}

<div class="card">
    <h3>Organizations</h3>
    <table>
        <thead>
            <tr>
                <th>Organization</th>
                <th>Active</th>
                <th>Inactive</th>
                <th>Total</th>
                <th>Last Sync</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for org_key in config.available_orgs %}
            {% set org_stats = stats.by_org.get(org_key, {'active': 0, 'inactive': 0, 'total': 0}) %}
            {% set last_sync = sync_status.get(org_key) %}
            <tr>
                <td><strong>{{ config.buz_orgs[org_key].display_name }}</strong></td>
                <td class="text-success">{{ org_stats.active }}</td>
                <td class="text-danger">{{ org_stats.inactive }}</td>
                <td>{{ org_stats.total }}</td>
                <td>
                    {% if last_sync %}
                        <span class="badge badge-{% if last_sync.status == 'success' %}success{% else %}error{% endif %}">
                            {{ last_sync.status }}
                        </span>
                        <span class="text-muted" title="{{ last_sync.synced_at }}">{{ time_ago(last_sync.synced_at) }}</span>
                    {% else %}
                        <span class="text-muted">Never synced</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="syncOrg('{{ org_key }}', this)">Sync</button>
                    <a href="{{ url_for('web.users', org=org_key) }}" class="btn btn-secondary btn-sm">View Users</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if unhealthy_orgs %}
<div class="card" style="background: #f8d7da; border: 1px solid #f5c6cb;">
    <h3>⚠️ Auth Issues Detected</h3>
    <p>The following organizations have authentication problems and need their Buz login renewed:</p>
    <table>
        <thead>
            <tr>
                <th>Organization</th>
                <th>Status</th>
                <th>Error</th>
                <th>Last Healthy</th>
                <th>Failures</th>
            </tr>
        </thead>
        <tbody>
            {% for org in unhealthy_orgs %}
            <tr>
                <td><strong>{{ org.org_key }}</strong></td>
                <td><span class="badge badge-{% if org.status == 'expired' %}error{% else %}failed{% endif %}">{{ org.status }}</span></td>
                <td class="text-muted">{{ org.error_message[:50] }}{% if org.error_message|length > 50 %}...{% endif %}</td>
                <td>{{ org.last_healthy[:16] if org.last_healthy else 'Never' }}</td>
                <td>{{ org.consecutive_failures }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <p style="margin-top: 15px;">
        <strong>To fix:</strong> Run <code>python banji/tools/buz_auth_bootstrap.py &lt;org&gt;</code> for each org,
        then copy the JSON file to <code>hugo/.secrets/</code>
    </p>
    <button class="btn btn-primary" onclick="checkAuth(this)">Re-check Auth Now</button>
</div>
{% endif %}

{% if config.buz_orgs_missing_auth %}
<div class="card" style="background: #fff3cd;">
    <h3>Missing Authentication</h3>
    <p>The following organizations need authentication setup:</p>
    <ul>
        {% for org_key, path in config.buz_orgs_missing_auth.items() %}
        <li><strong>{{ org_key }}</strong>: Run <code>python banji/tools/buz_auth_bootstrap.py {{ org_key }}</code></li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    async function checkAuth(button) {
        hideMessage();
        button.classList.add('loading');
        button.disabled = true;
        button.textContent = 'Checking...';

        try {
            const result = await apiCall('/api/auth/check', 'POST', {});
            if (result.success) {
                if (result.unhealthy > 0) {
                    showMessage(`Auth check complete: ${result.healthy} healthy, ${result.unhealthy} need attention`, 'info');
                } else {
                    showMessage('All auth sessions are healthy!', 'success');
                }
                setTimeout(() => location.reload(), 1500);
            } else if (result.error) {
                showMessage('Auth check failed: ' + result.error, 'error');
            }
        } catch (e) {
            showMessage('Auth check error: ' + e.message, 'error');
        }

        button.classList.remove('loading');
        button.disabled = false;
        button.textContent = 'Re-check Auth Now';
    }
</script>
{% endblock %}
