{% extends "base.html" %}

{% block title %}Sync History - {{ config.name }}{% endblock %}

{% block extra_css %}
<style>
    .time-cell {
        white-space: nowrap;
        cursor: help;
    }
    .running-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #f0ad4e;
        border-radius: 50%;
        margin-right: 6px;
        animation: pulse 1s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }
</style>
{% endblock %}

{% block content %}
<h2>Sync History</h2>

{% if running %}
<div class="card" style="border-left: 4px solid #f0ad4e; margin-bottom: 20px;">
    <h3><span class="running-indicator"></span> Sync in Progress</h3>
    <table>
        <thead>
            <tr>
                <th>Organization</th>
                <th>Started</th>
                <th>Elapsed</th>
            </tr>
        </thead>
        <tbody>
            {% for sync in running %}
            <tr>
                <td><strong>{{ config.buz_orgs[sync.org_key].display_name if config.buz_orgs[sync.org_key] else sync.org_key }}</strong></td>
                <td class="time-cell text-muted" title="{{ sync.started_at }}">{{ time_ago(sync.started_at) }}</td>
                <td><span class="elapsed-time" data-started="{{ sync.started_at }}">calculating...</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<div class="filters" style="margin-bottom: 20px;">
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <input type="search" id="searchInput" placeholder="Search by organization or status..." autocomplete="off" data-lpignore="true" data-form-type="other" style="min-width: 250px;">
        <span class="text-muted"><span id="visibleCount">{{ history|length }}</span> sync operations</span>
    </div>
</div>

<div id="noResults" class="card" style="display: none; text-align: center; padding: 40px;">
    <h3 style="color: #6c757d;">No sync operations found</h3>
    <p class="text-muted">Try a different search term.</p>
</div>

<div class="card" id="syncCard">
    <h3>All Sync Operations</h3>
    {% if history %}
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Organization</th>
                <th>Users</th>
                <th>Duration</th>
                <th>Status</th>
                <th>Error</th>
            </tr>
        </thead>
        <tbody id="syncTableBody">
            {% for entry in history %}
            <tr data-searchable="{{ entry.org_key|lower }} {{ config.buz_orgs[entry.org_key].display_name|lower if config.buz_orgs[entry.org_key] else '' }} {{ entry.status|lower }} {{ entry.error_message|lower if entry.error_message else '' }}">
                <td class="time-cell text-muted" title="{{ entry.synced_at or entry.started_at }}">
                    {{ time_ago(entry.synced_at or entry.started_at) }}
                </td>
                <td><strong>{{ config.buz_orgs[entry.org_key].display_name if config.buz_orgs[entry.org_key] else entry.org_key }}</strong></td>
                <td>{% if entry.status == 'running' %}-{% else %}{{ entry.user_count }}{% endif %}</td>
                <td>
                    {% if entry.status == 'running' %}
                    <span class="elapsed-time" data-started="{{ entry.started_at }}">...</span>
                    {% else %}
                    {{ "%.1f"|format(entry.duration_seconds) }}s
                    {% endif %}
                </td>
                <td>
                    <span class="badge badge-{% if entry.status == 'success' %}success{% elif entry.status == 'running' %}warning{% else %}error{% endif %}">
                        {% if entry.status == 'running' %}<span class="running-indicator"></span>{% endif %}
                        {{ entry.status }}
                    </span>
                </td>
                <td class="text-danger">{{ entry.error_message or '' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No sync operations recorded yet.</p>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
// Instant search functionality
(function() {
    const searchInput = document.getElementById('searchInput');
    const noResults = document.getElementById('noResults');
    const syncCard = document.getElementById('syncCard');
    const visibleCount = document.getElementById('visibleCount');
    const tableBody = document.getElementById('syncTableBody');

    if (searchInput && tableBody) {
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            const rows = tableBody.querySelectorAll('tr');
            let visible = 0;

            if (query === '') {
                rows.forEach(row => {
                    row.style.display = '';
                });
                visible = rows.length;
            } else {
                rows.forEach(row => {
                    const searchable = row.getAttribute('data-searchable') || '';
                    if (searchable.includes(query)) {
                        row.style.display = '';
                        visible++;
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            if (visibleCount) {
                visibleCount.textContent = visible;
            }

            if (visible === 0) {
                noResults.style.display = 'block';
                syncCard.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                syncCard.style.display = 'block';
            }
        });
    }
})();

function updateElapsedTimes() {
    document.querySelectorAll('.elapsed-time').forEach(function(el) {
        var started = el.getAttribute('data-started');
        if (!started) return;

        // Parse the timestamp (SQLite format: "2024-01-15 10:30:00")
        var startDate;
        if (started.includes('T')) {
            startDate = new Date(started);
        } else {
            startDate = new Date(started.replace(' ', 'T') + 'Z');
        }

        var now = new Date();
        var elapsed = Math.floor((now - startDate) / 1000);

        if (elapsed < 0) elapsed = 0;

        var minutes = Math.floor(elapsed / 60);
        var seconds = elapsed % 60;

        if (minutes > 0) {
            el.textContent = minutes + 'm ' + seconds + 's';
        } else {
            el.textContent = seconds + 's';
        }
    });
}

// Update immediately and then every second
updateElapsedTimes();
setInterval(updateElapsedTimes, 1000);

{% if running %}
// Auto-refresh page every 5 seconds while syncs are running
setTimeout(function() {
    window.location.reload();
}, 5000);
{% endif %}
</script>
{% endblock %}
