{% extends "base.html" %}

{% block title %}Activity Log - {{ config.name }}{% endblock %}

{% block extra_css %}
<style>
    .time-cell {
        white-space: nowrap;
        cursor: help;
    }
</style>
{% endblock %}

{% block content %}
<h2>Activity Log</h2>

<div class="filters">
    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <input type="search" id="searchInput" placeholder="Search by email, action, org, or performer..." autocomplete="off" data-lpignore="true" data-form-type="other" style="min-width: 300px;">
        <span class="text-muted"><span id="visibleCount">{{ activity|length }}</span> entries</span>
    </div>
</div>

<div id="noResults" class="card" style="display: none; text-align: center; padding: 40px;">
    <h3 style="color: #6c757d;">No activity found</h3>
    <p class="text-muted">Try a different search term.</p>
</div>

<div class="card" id="activityCard">
    {% if activity %}
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Action</th>
                <th>Email</th>
                <th>Organization</th>
                <th>Change</th>
                <th>By</th>
                <th>Result</th>
            </tr>
        </thead>
        <tbody id="activityTableBody">
            {% for entry in activity %}
            <tr data-searchable="{{ entry.email|lower }} {{ entry.action|lower }} {{ entry.org_key|lower }} {{ entry.performed_by|lower if entry.performed_by else '' }} {{ entry.old_value|lower if entry.old_value else '' }} {{ entry.new_value|lower if entry.new_value else '' }}">
                <td class="time-cell text-muted" title="{{ entry.performed_at }}">
                    {{ time_ago(entry.performed_at) }}
                </td>
                <td><strong>{{ entry.action }}</strong></td>
                <td><a href="{{ url_for('web.user_detail', email=entry.email) }}">{{ entry.email }}</a></td>
                <td>{{ entry.org_key }}</td>
                <td>{{ entry.old_value }} -> {{ entry.new_value }}</td>
                <td>{{ entry.performed_by }}</td>
                <td>
                    {% if entry.success %}
                    <span class="badge badge-success">Success</span>
                    {% else %}
                    <span class="badge badge-error">Failed</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No activity recorded yet.</p>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Instant search functionality
    const searchInput = document.getElementById('searchInput');
    const noResults = document.getElementById('noResults');
    const activityCard = document.getElementById('activityCard');
    const visibleCount = document.getElementById('visibleCount');
    const tableBody = document.getElementById('activityTableBody');

    if (searchInput && tableBody) {
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            const rows = tableBody.querySelectorAll('tr');
            let visible = 0;

            if (query === '') {
                rows.forEach(row => {
                    row.style.display = '';
                });
                visible = rows.length;
            } else {
                rows.forEach(row => {
                    const searchable = row.getAttribute('data-searchable') || '';
                    if (searchable.includes(query)) {
                        row.style.display = '';
                        visible++;
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            if (visibleCount) {
                visibleCount.textContent = visible;
            }

            if (visible === 0) {
                noResults.style.display = 'block';
                activityCard.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                activityCard.style.display = 'block';
            }
        });

        searchInput.focus();
    }
</script>
{% endblock %}
