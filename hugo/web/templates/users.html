{% extends "base.html" %}

{% block title %}Users - {{ config.name }}{% endblock %}

{% block extra_css %}
<style>
    .org-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    .org-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 600;
        white-space: nowrap;
    }

    .org-badge.active {
        background: #d4edda;
        color: #155724;
    }

    .org-badge.inactive {
        background: #f8d7da;
        color: #721c24;
        text-decoration: line-through;
        opacity: 0.7;
    }

    .org-badge .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        margin-right: 4px;
    }

    .org-badge.active .status-dot {
        background: #28a745;
    }

    .org-badge.inactive .status-dot {
        background: #dc3545;
    }

    .last-session {
        white-space: nowrap;
        font-size: 0.85em;
    }

    .user-count-summary {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .count-item {
        font-size: 0.9em;
    }

    .user-name {
        font-weight: 500;
    }

    .user-email {
        font-size: 0.85em;
        color: #6c757d;
    }

    /* Compact table for better density */
    table td {
        padding: 10px 12px;
        vertical-align: middle;
    }

    /* Name/email column styling */
    .user-identity {
        line-height: 1.4;
    }
</style>
{% endblock %}

{% block content %}
<h2>Buz Users</h2>

<div class="filters">
    <form method="get" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <select name="org" onchange="this.form.submit()">
            <option value="">All Organizations</option>
            {% for org_key in available_orgs %}
            <option value="{{ org_key }}" {% if filters.org == org_key %}selected{% endif %}>
                {{ config.buz_orgs[org_key].display_name }}
            </option>
            {% endfor %}
        </select>

        <select name="active" onchange="this.form.submit()">
            <option value="">All Status</option>
            <option value="true" {% if filters.active == true %}selected{% endif %}>Active</option>
            <option value="false" {% if filters.active == false %}selected{% endif %}>Inactive</option>
        </select>

        <select name="type" onchange="this.form.submit()">
            <option value="">All Types</option>
            <option value="employee" {% if filters.type == 'employee' %}selected{% endif %}>Employees</option>
            <option value="customer" {% if filters.type == 'customer' %}selected{% endif %}>Customers</option>
        </select>

        <a href="{{ url_for('web.users') }}" class="btn btn-secondary btn-sm">Clear Filters</a>
    </form>
</div>

<div class="card">
    <div class="user-count-summary">
        <span class="count-item"><strong>{{ users|length }}</strong> unique users</span>
        {% if raw_user_count != users|length %}
        <span class="count-item text-muted">({{ raw_user_count }} total entries across orgs)</span>
        {% endif %}
    </div>

    {% if users %}
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Organizations</th>
                <th>Type</th>
                <th>Last Session</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td class="user-identity">
                    <div class="user-name">
                        <a href="{{ url_for('web.user_detail', email=user.email) }}">{{ user.full_name or user.email }}</a>
                    </div>
                    {% if user.full_name %}
                    <div class="user-email">{{ user.email }}</div>
                    {% endif %}
                </td>
                <td>
                    <div class="org-badges">
                        {% for org in user.orgs|sort(attribute='org_key') %}
                        <span class="org-badge {% if org.is_active %}active{% else %}inactive{% endif %}"
                              title="{{ 'Active' if org.is_active else 'Inactive' }} in {{ config.buz_orgs[org.org_key].display_name }}{% if org.user_group %} ({{ org.user_group }}){% endif %}">
                            <span class="status-dot"></span>
                            {{ org.org_key[:3]|upper }}
                        </span>
                        {% endfor %}
                    </div>
                </td>
                <td>
                    <span class="badge badge-{{ user.user_type }}">{{ user.user_type }}</span>
                </td>
                <td class="last-session text-muted">
                    {% if user.last_session %}
                        {{ user.last_session[:10] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('web.user_detail', email=user.email) }}" class="btn btn-secondary btn-sm">Manage</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="margin-top: 15px;">No users found. Try <a href="{{ url_for('web.index') }}">syncing from the dashboard</a>.</p>
    {% endif %}
</div>

{% endblock %}
