{% extends "base.html" %}

{% block title %}Users - {{ config.name }}{% endblock %}

{% block extra_css %}
<style>
    .org-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    .org-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 600;
        white-space: nowrap;
    }

    .org-badge.active {
        background: #d4edda;
        color: #155724;
    }

    .org-badge.inactive {
        background: #f8d7da;
        color: #721c24;
        text-decoration: line-through;
        opacity: 0.7;
    }

    .org-badge .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        margin-right: 4px;
    }

    .org-badge.active .status-dot {
        background: #28a745;
    }

    .org-badge.inactive .status-dot {
        background: #dc3545;
    }

    .last-session {
        white-space: nowrap;
        font-size: 0.85em;
    }

    .user-count-summary {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .count-item {
        font-size: 0.9em;
    }

    .user-name {
        font-weight: 500;
    }

    .user-email {
        font-size: 0.85em;
        color: #6c757d;
    }

    /* Compact table for better density */
    table td {
        padding: 10px 12px;
        vertical-align: middle;
    }

    /* Name/email column styling */
    .user-identity {
        line-height: 1.4;
    }
</style>
{% endblock %}

{% block content %}
<h2>Buz Users</h2>

<div class="filters">
    <form method="get" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <input type="search" id="searchInput" placeholder="Search by name or email..." autocomplete="off" data-lpignore="true" data-form-type="other" style="min-width: 200px;">

        <select name="org" onchange="this.form.submit()">
            <option value="">All Organizations</option>
            {% for org_key in available_orgs %}
            <option value="{{ org_key }}" {% if filters.org == org_key %}selected{% endif %}>
                {{ config.buz_orgs[org_key].display_name }}
            </option>
            {% endfor %}
        </select>

        <select name="active" onchange="this.form.submit()">
            <option value="">All Status</option>
            <option value="true" {% if filters.active == true %}selected{% endif %}>Active</option>
            <option value="false" {% if filters.active == false %}selected{% endif %}>Inactive</option>
        </select>

        <select name="type" onchange="this.form.submit()">
            <option value="">All Types</option>
            <option value="employee" {% if filters.type == 'employee' %}selected{% endif %}>Employees</option>
            <option value="customer" {% if filters.type == 'customer' %}selected{% endif %}>Customers</option>
        </select>

        <a href="{{ url_for('web.users') }}" class="btn btn-secondary btn-sm">Clear Filters</a>
    </form>
</div>

<div id="noResults" class="card" style="display: none; text-align: center; padding: 40px;">
    <h3 style="color: #6c757d;">No users found</h3>
    <p class="text-muted">Try a different search term or adjust the filters.</p>
</div>

<div class="card" id="usersCard">
    <div class="user-count-summary">
        <span class="count-item"><strong id="visibleCount">{{ users|length }}</strong> unique users</span>
        {% if raw_user_count != users|length %}
        <span class="count-item text-muted">({{ raw_user_count }} total entries across orgs)</span>
        {% endif %}
    </div>

    {% if users %}
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>Organizations</th>
                <th>Type</th>
                <th>Last Session</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="usersTableBody">
            {% for user in users %}
            <tr data-searchable="{{ user.full_name|lower if user.full_name else '' }} {{ user.email|lower }} {% for org in user.orgs %}{{ org.org_key|lower }} {% endfor %}">
                <td class="user-identity">
                    <div class="user-name">
                        <a href="{{ url_for('web.user_detail', email=user.email) }}">{{ user.full_name or user.email }}</a>
                    </div>
                    {% if user.full_name %}
                    <div class="user-email">{{ user.email }}</div>
                    {% endif %}
                </td>
                <td>
                    <div class="org-badges">
                        {% for org in user.orgs|sort(attribute='org_key') %}
                        <span class="org-badge {% if org.is_active %}active{% else %}inactive{% endif %}"
                              title="{{ 'Active' if org.is_active else 'Inactive' }} in {{ config.buz_orgs[org.org_key].display_name }}{% if org.user_group %} ({{ org.user_group }}){% endif %}">
                            <span class="status-dot"></span>
                            {{ org.org_key[:3]|upper }}
                        </span>
                        {% endfor %}
                    </div>
                </td>
                <td>
                    <span class="badge badge-{{ user.user_type }}">{{ user.user_type }}</span>
                </td>
                <td class="last-session text-muted">
                    {% if user.last_session %}
                        {{ user.last_session[:10] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('web.user_detail', email=user.email) }}" class="btn btn-secondary btn-sm">Manage</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="margin-top: 15px;">No users found. Try <a href="{{ url_for('web.index') }}">syncing from the dashboard</a>.</p>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Instant search functionality
    const searchInput = document.getElementById('searchInput');
    const noResults = document.getElementById('noResults');
    const usersCard = document.getElementById('usersCard');
    const visibleCount = document.getElementById('visibleCount');
    const tableBody = document.getElementById('usersTableBody');

    if (searchInput && tableBody) {
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            const rows = tableBody.querySelectorAll('tr');
            let visible = 0;

            if (query === '') {
                // Show all rows when search is empty
                rows.forEach(row => {
                    row.style.display = '';
                });
                visible = rows.length;
            } else {
                // Filter rows based on search
                rows.forEach(row => {
                    const searchable = row.getAttribute('data-searchable') || '';
                    if (searchable.includes(query)) {
                        row.style.display = '';
                        visible++;
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            // Update count
            if (visibleCount) {
                visibleCount.textContent = visible;
            }

            // Show/hide no results message
            if (visible === 0) {
                noResults.style.display = 'block';
                usersCard.style.display = 'none';
            } else {
                noResults.style.display = 'none';
                usersCard.style.display = 'block';
            }
        });

        // Focus search input on page load
        searchInput.focus();

        // Prevent form submission on Enter in search field
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });
    }
</script>
{% endblock %}
