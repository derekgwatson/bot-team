{% extends "base.html" %}

{% block title %}{{ full_name or email }} - {{ config.name }}{% endblock %}

{% block extra_css %}
<style>
    .user-header {
        margin-bottom: 10px;
    }
    .user-header h2 {
        margin-bottom: 5px;
    }
    .user-header .email {
        color: #6c757d;
        font-size: 1em;
    }
    .last-session-cell {
        white-space: nowrap;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="user-header">
    <h2>{{ full_name or email }}</h2>
    {% if full_name %}
    <div class="email">{{ email }}</div>
    {% endif %}
</div>

<div class="card">
    <h3>Access by Organization</h3>
    <table>
        <thead>
            <tr>
                <th>Organization</th>
                <th>Type</th>
                <th>Status</th>
                <th>Group</th>
                <th>Last Session</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in user_records %}
            <tr>
                <td><strong>{{ config.buz_orgs[user.org_key].display_name if config.buz_orgs[user.org_key] else user.org_key }}</strong></td>
                <td>
                    <span class="badge badge-{{ user.user_type }}">{{ user.user_type }}</span>
                </td>
                <td>
                    <span class="badge badge-{% if user.is_active %}active{% else %}inactive{% endif %}">
                        {% if user.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                </td>
                <td>{{ user.user_group or '-' }}</td>
                <td class="last-session-cell text-muted">
                    {% if user.last_session %}
                        {{ user.last_session[:10] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                    <button class="btn btn-danger btn-sm toggle-btn"
                            onclick="toggleUser('{{ user.email }}', '{{ user.org_key }}', true, this)">
                        Deactivate
                    </button>
                    {% else %}
                    <button class="btn btn-success btn-sm toggle-btn"
                            onclick="toggleUser('{{ user.email }}', '{{ user.org_key }}', false, this)">
                        Activate
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card">
    <h3>Recent Activity</h3>
    {% if activity %}
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Action</th>
                <th>Organization</th>
                <th>Details</th>
                <th>By</th>
                <th>Result</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in activity %}
            <tr>
                <td class="text-muted">{{ entry.performed_at[:16] }}</td>
                <td><strong>{{ entry.action }}</strong></td>
                <td>{{ entry.org_key }}</td>
                <td>{{ entry.old_value }} -> {{ entry.new_value }}</td>
                <td>{{ entry.performed_by }}</td>
                <td>
                    {% if entry.success %}
                    <span class="badge badge-success">Success</span>
                    {% else %}
                    <span class="badge badge-error">Failed</span>
                    <span class="text-danger">{{ entry.error_message }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No activity recorded for this user.</p>
    {% endif %}
</div>

<p><a href="{{ url_for('web.users') }}">&larr; Back to Users</a></p>

{% endblock %}
