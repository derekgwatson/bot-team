{% extends "base.html" %}

{% block title %}{{ job.name }} - {{ config.name }}{% endblock %}

{% block content %}
<h2>{{ job.name }}</h2>

{% if running %}
<div class="card" style="background: #fff3cd; border: 1px solid #ffc107;">
    <div style="display: flex; align-items: center; gap: 10px;">
        <span class="spinner" style="width: 20px; height: 20px; border: 3px solid #ffc107; border-top-color: #856404; border-radius: 50%; animation: spin 1s linear infinite;"></span>
        <strong style="color: #856404;">Job is running...</strong>
        <span style="color: #856404; font-size: 13px;">
            (<span class="elapsed-time" data-started="{{ running[0].started_at }}">calculating...</span> - page will refresh automatically)
        </span>
    </div>
</div>
<style>
@keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endif %}

<div class="card">
    <h3>Job Configuration</h3>
    <table>
        <tr>
            <th style="width: 150px;">Job ID</th>
            <td><code>{{ job.job_id }}</code></td>
        </tr>
        <tr>
            <th>Description</th>
            <td>{{ job.description or '-' }}</td>
        </tr>
        <tr>
            <th>Target Bot</th>
            <td><strong>{{ job.target_bot }}</strong></td>
        </tr>
        <tr>
            <th>Endpoint</th>
            <td><code>{{ job.method }} {{ job.endpoint }}</code></td>
        </tr>
        <tr>
            <th>Schedule Type</th>
            <td>{{ job.schedule_type }}</td>
        </tr>
        <tr>
            <th>Schedule Config</th>
            <td><code>{{ job.schedule_config }}</code></td>
        </tr>
        <tr>
            <th>Status</th>
            <td>
                {% if running %}
                    <span class="badge" style="background: #ffc107; color: #856404;">Running</span>
                {% elif job.enabled %}
                    <span class="badge badge-enabled">Enabled</span>
                {% else %}
                    <span class="badge badge-disabled">Disabled</span>
                {% endif %}
                {% if job.quiet %}
                    <span class="badge" style="background: #6c757d; color: white; margin-left: 5px;">Quiet</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Next Run</th>
            <td>
                {% if job.next_run_time %}
                    <strong><span class="local-time" data-utc="{{ job.next_run_time }}">{{ job.next_run_time|relative_time }}</span></strong>
                {% else %}
                    <span class="text-muted">Not scheduled</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Last Run</th>
            <td>
                {% if job.last_run %}
                    <span class="local-time" data-utc="{{ job.last_run }}">{{ job.last_run|relative_time }}</span>
                {% else %}
                    Never
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Last Success</th>
            <td>
                {% if job.last_success %}
                    <span class="local-time" data-utc="{{ job.last_success }}">{{ job.last_success|relative_time }}</span>
                {% else %}
                    Never
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Created By</th>
            <td>{{ job.created_by or '-' }}</td>
        </tr>
        <tr>
            <th>Created At</th>
            <td>
                {% if job.created_at %}
                    <span class="local-time" data-utc="{{ job.created_at }}">{{ job.created_at|relative_time }}</span>
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
    </table>

    {% if current_user.is_admin %}
    <div class="actions" style="margin-top: 20px;">
        <form action="{{ url_for('web.run_job', job_id=job.job_id) }}" method="post" style="display:inline;">
            <button type="submit" class="btn btn-primary" {% if running %}disabled{% endif %}>
                {% if running %}Running...{% else %}Run Now{% endif %}
            </button>
        </form>
        <form action="{{ url_for('web.toggle_job', job_id=job.job_id) }}" method="post" style="display:inline;">
            <button type="submit" class="btn btn-secondary">
                {% if job.enabled %}Disable{% else %}Enable{% endif %}
            </button>
        </form>
        <a href="{{ url_for('web.edit_job', job_id=job.job_id) }}" class="btn btn-secondary">Edit</a>
        <form action="{{ url_for('web.delete_job', job_id=job.job_id) }}" method="post" style="display:inline;" class="confirm-form">
            <button type="button" class="btn btn-danger confirm-trigger">Delete</button>
            <span class="confirm-state" style="display: none;">
                <button type="submit" class="btn btn-danger">Yes, Delete</button>
                <button type="button" class="btn cancel-confirm" style="background: #95a5a6;">Cancel</button>
            </span>
        </form>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3>Execution History</h3>
    {% if history %}
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Status</th>
                <th>Response</th>
                <th>Duration</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for exec in history %}
            <tr>
                <td>
                    {% if exec.status == 'running' and exec.started_at %}
                        <span class="local-time" data-utc="{{ exec.started_at }}">{{ exec.started_at|relative_time }}</span>
                    {% elif exec.executed_at %}
                        <span class="local-time" data-utc="{{ exec.executed_at }}">{{ exec.executed_at|relative_time }}</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if exec.status == 'running' %}
                        <span class="badge" style="background: #ffc107; color: #856404;">running</span>
                    {% else %}
                        <span class="badge badge-{{ exec.status }}">{{ exec.status }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if exec.response_code %}
                        HTTP {{ exec.response_code }}
                    {% elif exec.error_message %}
                        <span class="text-danger">Error</span>
                    {% elif exec.status == 'running' %}
                        <span class="text-muted">...</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if exec.status == 'running' %}
                        <span class="elapsed-time" data-started="{{ exec.started_at }}">...</span>
                    {% else %}
                        {{ exec.duration_ms or '-' }}ms
                    {% endif %}
                </td>
                <td>
                    {% if exec.error_message %}
                        <small class="text-danger">{{ exec.error_message[:100] }}</small>
                    {% elif exec.response_body %}
                        <small>{{ exec.response_body[:100] }}...</small>
                    {% elif exec.status == 'running' %}
                        <small class="text-muted">In progress...</small>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No execution history yet.</p>
    {% endif %}
</div>

<p style="margin-top: 20px;">
    <a href="{{ url_for('web.jobs_list') }}">&larr; Back to Jobs</a>
</p>

<script>
// Confirmation pattern for delete
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('confirm-trigger')) {
        const form = e.target.closest('.confirm-form');
        e.target.style.display = 'none';
        form.querySelector('.confirm-state').style.display = 'inline';
    }
    if (e.target.classList.contains('cancel-confirm')) {
        const form = e.target.closest('.confirm-form');
        form.querySelector('.confirm-state').style.display = 'none';
        form.querySelector('.confirm-trigger').style.display = '';
    }
});

// Elapsed time for running jobs
function formatElapsed(seconds) {
    if (seconds < 60) return seconds + 's';
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (mins < 60) return mins + 'm ' + secs + 's';
    const hours = Math.floor(mins / 60);
    const remainMins = mins % 60;
    return hours + 'h ' + remainMins + 'm';
}

function updateElapsedTimes() {
    document.querySelectorAll('.elapsed-time').forEach(function(el) {
        const started = el.dataset.started;
        if (!started) return;
        // Parse SQLite timestamp (YYYY-MM-DD HH:MM:SS) as UTC
        const startTime = new Date(started.replace(' ', 'T') + 'Z');
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        el.textContent = formatElapsed(elapsed);
    });
}

updateElapsedTimes();
setInterval(updateElapsedTimes, 1000);

// Auto-refresh while job is running
{% if running %}
setTimeout(function() {
    window.location.reload();
}, 3000);
{% endif %}
</script>
{% endblock %}
