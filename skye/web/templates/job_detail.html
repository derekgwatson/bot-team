{% extends "base.html" %}

{% block title %}{{ job.name }} - {{ config.name }}{% endblock %}

{% block content %}
<h2>{{ job.name }}</h2>

<div class="card">
    <h3>Job Configuration</h3>
    <table>
        <tr>
            <th style="width: 150px;">Job ID</th>
            <td><code>{{ job.job_id }}</code></td>
        </tr>
        <tr>
            <th>Description</th>
            <td>{{ job.description or '-' }}</td>
        </tr>
        <tr>
            <th>Target Bot</th>
            <td><strong>{{ job.target_bot }}</strong></td>
        </tr>
        <tr>
            <th>Endpoint</th>
            <td><code>{{ job.method }} {{ job.endpoint }}</code></td>
        </tr>
        <tr>
            <th>Schedule Type</th>
            <td>{{ job.schedule_type }}</td>
        </tr>
        <tr>
            <th>Schedule Config</th>
            <td><code>{{ job.schedule_config }}</code></td>
        </tr>
        <tr>
            <th>Status</th>
            <td>
                {% if job.enabled %}
                    <span class="badge badge-enabled">Enabled</span>
                {% else %}
                    <span class="badge badge-disabled">Disabled</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Next Run</th>
            <td>
                {% if job.next_run_time %}
                    <strong>{{ job.next_run_time }}</strong>
                {% else %}
                    <span class="text-muted">Not scheduled</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Last Run</th>
            <td>{{ job.last_run or 'Never' }}</td>
        </tr>
        <tr>
            <th>Last Success</th>
            <td>{{ job.last_success or 'Never' }}</td>
        </tr>
        <tr>
            <th>Created By</th>
            <td>{{ job.created_by or '-' }}</td>
        </tr>
        <tr>
            <th>Created At</th>
            <td>{{ job.created_at }}</td>
        </tr>
    </table>

    {% if current_user.is_admin %}
    <div class="actions" style="margin-top: 20px;">
        <form action="{{ url_for('web.run_job', job_id=job.job_id) }}" method="post" style="display:inline;">
            <button type="submit" class="btn btn-primary">Run Now</button>
        </form>
        <form action="{{ url_for('web.toggle_job', job_id=job.job_id) }}" method="post" style="display:inline;">
            <button type="submit" class="btn btn-secondary">
                {% if job.enabled %}Disable{% else %}Enable{% endif %}
            </button>
        </form>
        <a href="{{ url_for('web.edit_job', job_id=job.job_id) }}" class="btn btn-secondary">Edit</a>
        <form action="{{ url_for('web.delete_job', job_id=job.job_id) }}" method="post" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this job?');">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3>Execution History</h3>
    {% if history %}
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Status</th>
                <th>Response</th>
                <th>Duration</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for exec in history %}
            <tr>
                <td>{{ exec.executed_at }}</td>
                <td>
                    <span class="badge badge-{{ exec.status }}">{{ exec.status }}</span>
                </td>
                <td>
                    {% if exec.response_code %}
                        HTTP {{ exec.response_code }}
                    {% elif exec.error_message %}
                        <span class="text-danger">Error</span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ exec.duration_ms or '-' }}ms</td>
                <td>
                    {% if exec.error_message %}
                        <small class="text-danger">{{ exec.error_message[:100] }}</small>
                    {% elif exec.response_body %}
                        <small>{{ exec.response_body[:100] }}...</small>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="text-muted">No execution history yet.</p>
    {% endif %}
</div>

<p style="margin-top: 20px;">
    <a href="{{ url_for('web.jobs_list') }}">&larr; Back to Jobs</a>
</p>
{% endblock %}
