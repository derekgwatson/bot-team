{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Staff Directory</h2>

    <div class="search-bar">
        <input type="search" id="searchInput" placeholder="Start typing to filter by name, position, extension, email..." autocomplete="off" data-lpignore="true" data-form-type="other">
    </div>

    <div id="noResults" style="display: none; text-align: center; padding: 40px; color: #7f8c8d;">
        <h3>No matching staff found</h3>
        <p>Try a different search term.</p>
    </div>

    {% if error %}
    <div class="error">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    {% if sections %}
        {% for section_name, staff_list in sections.items() %}
        <div class="section-header" data-section="{{ section_name }}">{{ section_name }}</div>

        <table data-section="{{ section_name }}">
            <thead>
                <tr>
                    <th>Ext</th>
                    <th>Name</th>
                    <th>Position</th>
                    <th>Contact</th>
                    <th>System Access</th>
                    <th>Visibility</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for staff in staff_list %}
                <tr class="staff-row" data-searchable="{{ section_name|lower }} {{ staff.name|lower }} {{ staff.position|lower if staff.position else '' }} {{ staff.extension or '' }} {{ staff.phone_fixed or '' }} {{ staff.phone_mobile or '' }} {{ staff.work_email|lower if staff.work_email else '' }} {{ staff.personal_email|lower if staff.personal_email else '' }}">
                    <td>
                        {% if staff.extension %}
                        <span class="badge">{{ staff.extension }}</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="min-width: 150px;">
                        <strong>{{ staff.name }}</strong>
                    </td>
                    <td>{{ staff.position if staff.position else '-' }}</td>
                    <td style="min-width: 200px;">
                        {% if staff.phone_fixed %}
                        üìû <a href="tel:{{ staff.phone_fixed }}">{{ staff.phone_fixed }}</a><br>
                        {% endif %}
                        {% if staff.phone_mobile %}
                        üì± <a href="tel:{{ staff.phone_mobile }}">{{ staff.phone_mobile }}</a><br>
                        {% endif %}
                        {% if staff.work_email %}
                        ‚úâÔ∏è <a href="mailto:{{ staff.work_email }}">{{ staff.work_email }}</a>
                        {% elif staff.personal_email %}
                        ‚úâÔ∏è <a href="mailto:{{ staff.personal_email }}">{{ staff.personal_email }}</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if staff.zendesk_access %}
                        <span class="badge" style="background: #9b59b6; font-size: 10px; margin: 2px;">Zendesk</span>
                        {% endif %}
                        {% if staff.buz_access %}
                        <span class="badge" style="background: #3498db; font-size: 10px; margin: 2px;">Buz</span>
                        {% endif %}
                        {% if staff.google_access %}
                        <span class="badge" style="background: #e74c3c; font-size: 10px; margin: 2px;">Google</span>
                        {% endif %}
                        {% if staff.wiki_access %}
                        <span class="badge" style="background: #f39c12; font-size: 10px; margin: 2px;">Wiki</span>
                        {% endif %}
                        {% if staff.voip_access %}
                        <span class="badge" style="background: #1abc9c; font-size: 10px; margin: 2px;">VOIP</span>
                        {% endif %}
                        {% if not (staff.zendesk_access or staff.buz_access or staff.google_access or staff.wiki_access or staff.voip_access) %}
                        <span style="color: #999;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if staff.show_on_phone_list %}
                        <span class="badge" style="background: #27ae60; font-size: 10px;">üìã Phone List</span>
                        {% endif %}
                        {% if staff.include_in_allstaff %}
                        <span class="badge" style="background: #2980b9; font-size: 10px;">üë• All-Staff</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/edit/{{ staff.id }}" class="btn btn-small" style="background: #3498db; margin-right: 5px;">
                            Edit
                        </a>
                        <form method="POST" action="/delete/{{ staff.id }}" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-small"
                                    onclick="return confirm('Deactivate {{ staff.name }}? This will set their status to inactive.')">
                                Deactivate
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}
    {% else %}
    <div class="empty-state">
        <h3>No staff found</h3>
        <p>The staff directory is empty.</p>
        <a href="/add" class="btn" style="margin-top: 20px;">Add Your First Staff Member</a>
    </div>
    {% endif %}
</div>

<script>
    // Live search functionality
    const searchInput = document.getElementById('searchInput');
    const noResults = document.getElementById('noResults');
    const staffRows = document.querySelectorAll('.staff-row');
    const sectionHeaders = document.querySelectorAll('.section-header');
    const tables = document.querySelectorAll('table[data-section]');

    function doFilter(query) {
        let visibleCount = 0;

        if (query === '') {
            // Show everything if search is empty
            staffRows.forEach(row => row.style.display = '');
            sectionHeaders.forEach(header => header.style.display = '');
            tables.forEach(table => table.style.display = '');
            noResults.style.display = 'none';
            return;
        }

        // Track which sections have visible rows
        const sectionsWithResults = new Set();

        // Filter rows
        staffRows.forEach(row => {
            const searchable = row.getAttribute('data-searchable');
            if (searchable.includes(query)) {
                row.style.display = '';
                visibleCount++;
                // Find the section this row belongs to
                const table = row.closest('table');
                if (table) {
                    sectionsWithResults.add(table.getAttribute('data-section'));
                }
            } else {
                row.style.display = 'none';
            }
        });

        // Show/hide section headers and tables based on whether they have visible rows
        sectionHeaders.forEach(header => {
            const sectionName = header.getAttribute('data-section');
            header.style.display = sectionsWithResults.has(sectionName) ? '' : 'none';
        });

        tables.forEach(table => {
            const sectionName = table.getAttribute('data-section');
            table.style.display = sectionsWithResults.has(sectionName) ? '' : 'none';
        });

        // Show/hide no results message
        noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }

    // Save search term to localStorage on input
    searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (this.value) {
            localStorage.setItem('peterSearchTerm', this.value);
        } else {
            localStorage.removeItem('peterSearchTerm');
        }
        doFilter(query);
    });

    // Handle native clear button (fires 'search' event when cleared)
    searchInput.addEventListener('search', function() {
        if (!this.value) {
            localStorage.removeItem('peterSearchTerm');
            doFilter('');
        }
    });

    // Restore search term from localStorage on page load
    const savedSearch = localStorage.getItem('peterSearchTerm');
    if (savedSearch) {
        searchInput.value = savedSearch;
        doFilter(savedSearch.toLowerCase().trim());
    }

    // Focus search input on page load
    searchInput.focus();
</script>
{% endblock %}
